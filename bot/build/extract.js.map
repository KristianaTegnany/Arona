{"version":3,"sources":["../node_modules/tar-stream/extract.js"],"names":["util","require","bl","xtend","headers","Writable","PassThrough","noop","overflow","size","emptyStream","s","end","mixinPax","header","pax","path","name","linkpath","linkname","Extract","opts","call","_buffer","_missing","_onparse","_header","_stream","_overflow","_cb","_locked","_destroyed","_pax","_paxGlobal","self","b","oncontinue","_continue","onunlock","err","destroy","onstreamend","drain","_parse","ondrain","onheader","consume","onpaxglobalheader","decodePax","slice","onpaxheader","decode","emit","type","inherits","prototype","onparse","cb","_write","undefined","data","enc","missing","length","write","append","module","exports"],"mappings":"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","sourcesContent":["var util = require('util')\nvar bl = require('bl')\nvar xtend = require('xtend')\nvar headers = require('./headers')\n\nvar Writable = require('readable-stream').Writable\nvar PassThrough = require('readable-stream').PassThrough\n\nvar noop = function() {}\n\nvar overflow = function(size) {\n  size &= 511\n  return size && 512 - size\n}\n\nvar emptyStream = function() {\n  var s = new PassThrough()\n  s.end()\n  return s\n}\n\nvar mixinPax = function(header, pax) {\n  if (pax.path) header.name = pax.path\n  if (pax.linkpath) header.linkname = pax.linkpath\n  return header\n}\n\nvar Extract = function(opts) {\n  if (!(this instanceof Extract)) return new Extract(opts)\n  Writable.call(this, opts)\n\n  this._buffer = bl()\n  this._missing = 0\n  this._onparse = noop\n  this._header = null\n  this._stream = null\n  this._overflow = null\n  this._cb = null\n  this._locked = false\n  this._destroyed = false\n  this._pax = null\n  this._paxGlobal = null\n\n  var self = this\n  var b = self._buffer\n\n  var oncontinue = function() {\n    self._continue()\n  }\n\n  var onunlock = function(err) {\n    self._locked = false\n    if (err) return self.destroy(err)\n    if (!self._stream) oncontinue()\n  }\n\n  var onstreamend = function() {\n    self._stream = null\n    var drain = overflow(self._header.size)\n    if (drain) self._parse(drain, ondrain)\n    else self._parse(512, onheader)\n    if (!self._locked) oncontinue()\n  }\n\n  var ondrain = function() {\n    self._buffer.consume(overflow(self._header.size))\n    self._parse(512, onheader)\n    oncontinue()\n  }\n\n  var onpaxglobalheader = function() {\n    var size = self._header.size\n    self._paxGlobal = headers.decodePax(b.slice(0, size))\n    b.consume(size)\n    onstreamend()\n  }\n\n  var onpaxheader = function() {\n    var size = self._header.size\n    self._pax = headers.decodePax(b.slice(0, size))\n    if (self._paxGlobal) self._pax = xtend(self._paxGlobal, self._pax)\n    b.consume(size)\n    onstreamend()\n  }\n\n  var onheader = function() {\n    var header\n    try {\n      header = self._header = headers.decode(b.slice(0, 512))\n    } catch (err) {\n      self.emit('error', err)\n    }\n    b.consume(512)\n\n    if (!header) {\n      self._parse(512, onheader)\n      oncontinue()\n      return\n    }\n    if (header.type === 'pax-global-header') {\n      self._parse(header.size, onpaxglobalheader)\n      oncontinue()\n      return\n    }\n    if (header.type === 'pax-header') {\n      self._parse(header.size, onpaxheader)\n      oncontinue()\n      return\n    }\n\n    if (self._pax) {\n      self._header = header = mixinPax(header, self._pax)\n      self._pax = null\n    }\n\n    self._locked = true\n\n    if (!header.size) {\n      self._parse(512, onheader)\n      self.emit('entry', header, emptyStream(), onunlock)\n      return\n    }\n\n    self._stream = new PassThrough()\n\n    self.emit('entry', header, self._stream, onunlock)\n    self._parse(header.size, onstreamend)\n    oncontinue()\n  }\n\n  this._parse(512, onheader)\n}\n\nutil.inherits(Extract, Writable)\n\nExtract.prototype.destroy = function(err) {\n  if (this._destroyed) return\n  this._destroyed = true\n\n  if (err) this.emit('error', err)\n  this.emit('close')\n  if (this._stream) this._stream.emit('close')\n}\n\nExtract.prototype._parse = function(size, onparse) {\n  if (this._destroyed) return\n  this._missing = size\n  this._onparse = onparse\n}\n\nExtract.prototype._continue = function(err) {\n  if (this._destroyed) return\n  var cb = this._cb\n  this._cb = noop\n  if (this._overflow) this._write(this._overflow, undefined, cb)\n  else cb()\n}\n\nExtract.prototype._write = function(data, enc, cb) {\n  if (this._destroyed) return\n\n  var s = this._stream\n  var b = this._buffer\n  var missing = this._missing\n\n  // we do not reach end-of-chunk now. just forward it\n\n  if (data.length < missing) {\n    this._missing -= data.length\n    this._overflow = null\n    if (s) return s.write(data, cb)\n    b.append(data)\n    return cb()\n  }\n\n  // end-of-chunk. the parser should call cb.\n\n  this._cb = cb\n  this._missing = 0\n\n  var overflow = null\n  if (data.length > missing) {\n    overflow = data.slice(missing)\n    data = data.slice(0, missing)\n  }\n\n  if (s) s.end(data)\n  else b.append(data)\n\n  this._overflow = overflow\n  this._onparse()\n}\n\nmodule.exports = Extract\n"],"file":"extract.js"}