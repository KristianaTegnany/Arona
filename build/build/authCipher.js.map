{"version":3,"sources":["../node_modules/browserify-aes/authCipher.js"],"names":["aes","require","Buffer","Transform","inherits","GHASH","xor","incr32","out","a","b","len","Math","i","iv","self","ghash","toPad","ivBits","tail","h","ck","calcIv","StreamCipher","rump","chunk","tag","xorTest","buf","module"],"mappings":"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","sourcesContent":["var aes = require('./aes')\nvar Buffer = require('safe-buffer').Buffer\nvar Transform = require('cipher-base')\nvar inherits = require('inherits')\nvar GHASH = require('./ghash')\nvar xor = require('buffer-xor')\nvar incr32 = require('./incr32')\n\nfunction xorTest (a, b) {\n  var out = 0\n  if (a.length !== b.length) out++\n\n  var len = Math.min(a.length, b.length)\n  for (var i = 0; i < len; ++i) {\n    out += (a[i] ^ b[i])\n  }\n\n  return out\n}\n\nfunction calcIv (self, iv, ck) {\n  if (iv.length === 12) {\n    self._finID = Buffer.concat([iv, Buffer.from([0, 0, 0, 1])])\n    return Buffer.concat([iv, Buffer.from([0, 0, 0, 2])])\n  }\n  var ghash = new GHASH(ck)\n  var len = iv.length\n  var toPad = len % 16\n  ghash.update(iv)\n  if (toPad) {\n    toPad = 16 - toPad\n    ghash.update(Buffer.alloc(toPad, 0))\n  }\n  ghash.update(Buffer.alloc(8, 0))\n  var ivBits = len * 8\n  var tail = Buffer.alloc(8)\n  tail.writeUIntBE(ivBits, 0, 8)\n  ghash.update(tail)\n  self._finID = ghash.state\n  var out = Buffer.from(self._finID)\n  incr32(out)\n  return out\n}\nfunction StreamCipher (mode, key, iv, decrypt) {\n  Transform.call(this)\n\n  var h = Buffer.alloc(4, 0)\n\n  this._cipher = new aes.AES(key)\n  var ck = this._cipher.encryptBlock(h)\n  this._ghash = new GHASH(ck)\n  iv = calcIv(this, iv, ck)\n\n  this._prev = Buffer.from(iv)\n  this._cache = Buffer.allocUnsafe(0)\n  this._secCache = Buffer.allocUnsafe(0)\n  this._decrypt = decrypt\n  this._alen = 0\n  this._len = 0\n  this._mode = mode\n\n  this._authTag = null\n  this._called = false\n}\n\ninherits(StreamCipher, Transform)\n\nStreamCipher.prototype._update = function (chunk) {\n  if (!this._called && this._alen) {\n    var rump = 16 - (this._alen % 16)\n    if (rump < 16) {\n      rump = Buffer.alloc(rump, 0)\n      this._ghash.update(rump)\n    }\n  }\n\n  this._called = true\n  var out = this._mode.encrypt(this, chunk)\n  if (this._decrypt) {\n    this._ghash.update(chunk)\n  } else {\n    this._ghash.update(out)\n  }\n  this._len += chunk.length\n  return out\n}\n\nStreamCipher.prototype._final = function () {\n  if (this._decrypt && !this._authTag) throw new Error('Unsupported state or unable to authenticate data')\n\n  var tag = xor(this._ghash.final(this._alen * 8, this._len * 8), this._cipher.encryptBlock(this._finID))\n  if (this._decrypt && xorTest(tag, this._authTag)) throw new Error('Unsupported state or unable to authenticate data')\n\n  this._authTag = tag\n  this._cipher.scrub()\n}\n\nStreamCipher.prototype.getAuthTag = function getAuthTag () {\n  if (this._decrypt || !Buffer.isBuffer(this._authTag)) throw new Error('Attempting to get auth tag in unsupported state')\n\n  return this._authTag\n}\n\nStreamCipher.prototype.setAuthTag = function setAuthTag (tag) {\n  if (!this._decrypt) throw new Error('Attempting to set auth tag in unsupported state')\n\n  this._authTag = tag\n}\n\nStreamCipher.prototype.setAAD = function setAAD (buf) {\n  if (this._called) throw new Error('Attempting to set AAD in unsupported state')\n\n  this._ghash.update(buf)\n  this._alen += buf.length\n}\n\nmodule.exports = StreamCipher\n"],"file":"authCipher.js"}