{"version":3,"sources":["../node_modules/phantomjs/install.js"],"names":["requestProgress","require","progress","extractZip","cp","fs","hasha","helper","kew","path","request","url","which","originalPath","process","env","PATH","DEFAULT_CDN","validExit","on","console","log","exit","cleanPath","libPath","join","__dirname","pkgPath","phantomPath","resolve","then","tryPhantomjsInLib","tryPhantomjsOnPath","downloadPhantomjs","extractDownload","extractedPath","copyIntoPlace","location","getTargetPlatform","chmodSync","err","code","error","relativeLocation","relative","writeLocationFile","fail","stack","replace","platform","arch","getTargetArch","contents","test","writeFileSync","findSuitableTempDirectory","now","Date","candidateTmpDirs","TMPDIR","TEMP","npm_config_tmp","cwd","i","length","candidatePath","mkdirsSync","testFile","unlinkSync","e","message","getRequestOptions","strictSSL","npm_config_strict_ssl","version","options","uri","getDownloadUrl","encoding","followRedirect","headers","proxyUrl","npm_config_https_proxy","npm_config_http_proxy","npm_config_proxy","proxy","parse","auth","format","npm_config_user_agent","ca","npm_config_ca","npm_config_cafile","readFileSync","split","shift","agentOptions","handleRequestError","indexOf","requestBinary","requestOptions","filePath","deferred","defer","writePath","bar","response","body","statusCode","Math","floor","renameSync","JSON","stringify","state","total","size","width","curr","transferred","tick","promise","substr","dir","reject","execFile","targetPath","nfcall","remove","files","readdirSync","file","statSync","isDirectory","move","Error","getLocationInLibModuleIfMatching","libModule","resolvedLocation","dirname","fcall","result","globalLocation","realpathSync","checkPhantomjsVersion","matches","spec","getDownloadSpec","cdnUrl","npm_config_phantomjs_cdnurl","PHANTOMJS_CDNURL","downloadUrl","checksum","downloadSpec","downloadedFile","tmpPath","fileName","pop","existsSync","verifyChecksum","verified","fromFile","algorithm","hash","stdout","trim","PHANTOMJS_PLATFORM","PHANTOMJS_ARCH"],"mappings":"AAAA;;AAEA;;;AAIA;;AAEA,IAAIA,eAAe,GAAGC,OAAO,CAAC,kBAAD,CAA7B;;AACA,IAAIC,QAAQ,GAAGD,OAAO,CAAC,UAAD,CAAtB;;AACA,IAAIE,UAAU,GAAGF,OAAO,CAAC,aAAD,CAAxB;;AACA,IAAIG,EAAE,GAAGH,OAAO,CAAC,eAAD,CAAhB;;AACA,IAAII,EAAE,GAAGJ,OAAO,CAAC,UAAD,CAAhB;;AACA,IAAIK,KAAK,GAAGL,OAAO,CAAC,OAAD,CAAnB;;AACA,IAAIM,MAAM,GAAGN,OAAO,CAAC,iBAAD,CAApB;;AACA,IAAIO,GAAG,GAAGP,OAAO,CAAC,KAAD,CAAjB;;AACA,IAAIQ,IAAI,GAAGR,OAAO,CAAC,MAAD,CAAlB;;AACA,IAAIS,OAAO,GAAGT,OAAO,CAAC,SAAD,CAArB;;AACA,IAAIU,GAAG,GAAGV,OAAO,CAAC,KAAD,CAAjB;;AACA,IAAIW,KAAK,GAAGX,OAAO,CAAC,OAAD,CAAnB;;AAEA,IAAIY,YAAY,GAAGC,OAAO,CAACC,GAAR,CAAYC,IAA/B;AACA,IAAIC,WAAW,GAAG,+DAAlB,C,CAEA;;AACA,IAAIC,SAAS,GAAG,KAAhB;AAEAJ,OAAO,CAACK,EAAR,CAAW,MAAX,EAAmB,YAAY;AAC7B,MAAI,CAACD,SAAL,EAAgB;AACdE,IAAAA,OAAO,CAACC,GAAR,CAAY,6BAAZ;AACAC,IAAAA,IAAI,CAAC,CAAD,CAAJ;AACD;AACF,CALD,E,CAOA;AACA;AACA;;AACAR,OAAO,CAACC,GAAR,CAAYC,IAAZ,GAAmBT,MAAM,CAACgB,SAAP,CAAiBV,YAAjB,CAAnB;AAEA,IAAIW,OAAO,GAAGf,IAAI,CAACgB,IAAL,CAAUC,SAAV,EAAqB,KAArB,CAAd;AACA,IAAIC,OAAO,GAAGlB,IAAI,CAACgB,IAAL,CAAUD,OAAV,EAAmB,SAAnB,CAAd;AACA,IAAII,WAAW,GAAG,IAAlB,C,CAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AACApB,GAAG,CAACqB,OAAJ,CAAY,IAAZ,EACGC,IADH,CACQC,iBADR,EAEGD,IAFH,CAEQE,kBAFR,EAGGF,IAHH,CAGQG,iBAHR,EAIGH,IAJH,CAIQI,eAJR,EAKGJ,IALH,CAKQ,UAAUK,aAAV,EAAyB;AAC7B,SAAOC,aAAa,CAACD,aAAD,EAAgBR,OAAhB,CAApB;AACD,CAPH,EAQGG,IARH,CAQQ,YAAY;AAChB,MAAIO,QAAQ,GAAGC,iBAAiB,OAAO,OAAxB,GACX7B,IAAI,CAACgB,IAAL,CAAUE,OAAV,EAAmB,eAAnB,CADW,GAEXlB,IAAI,CAACgB,IAAL,CAAUE,OAAV,EAAmB,KAAnB,EAA0B,WAA1B,CAFJ;;AAIA,MAAI;AACF;AACAtB,IAAAA,EAAE,CAACkC,SAAH,CAAaF,QAAb,EAAuB,KAAvB;AACD,GAHD,CAGE,OAAOG,GAAP,EAAY;AACZ,QAAIA,GAAG,CAACC,IAAJ,IAAY,QAAhB,EAA0B;AACxBrB,MAAAA,OAAO,CAACsB,KAAR,CAAc,wDAAd,EAAwEL,QAAxE;AACAf,MAAAA,IAAI,CAAC,CAAD,CAAJ;AACD;;AACD,UAAMkB,GAAN;AACD;;AAED,MAAIG,gBAAgB,GAAGlC,IAAI,CAACmC,QAAL,CAAcpB,OAAd,EAAuBa,QAAvB,CAAvB;AACAQ,EAAAA,iBAAiB,CAACF,gBAAD,CAAjB;AAEAvB,EAAAA,OAAO,CAACC,GAAR,CAAY,qCAAZ,EAAmDgB,QAAnD;AACAf,EAAAA,IAAI,CAAC,CAAD,CAAJ;AACD,CA7BH,EA8BGwB,IA9BH,CA8BQ,UAAUN,GAAV,EAAe;AACnBpB,EAAAA,OAAO,CAACsB,KAAR,CAAc,6BAAd,EAA6CF,GAA7C,EAAkDA,GAAG,CAACO,KAAtD;AACAzB,EAAAA,IAAI,CAAC,CAAD,CAAJ;AACD,CAjCH;;AAoCA,SAASuB,iBAAT,CAA2BR,QAA3B,EAAqC;AACnCjB,EAAAA,OAAO,CAACC,GAAR,CAAY,0BAAZ;;AACA,MAAIiB,iBAAiB,OAAO,OAA5B,EAAqC;AACnCD,IAAAA,QAAQ,GAAGA,QAAQ,CAACW,OAAT,CAAiB,KAAjB,EAAwB,MAAxB,CAAX;AACD;;AAED,MAAIC,QAAQ,GAAGX,iBAAiB,EAAhC;AACA,MAAIY,IAAI,GAAGC,aAAa,EAAxB;AAEA,MAAIC,QAAQ,GAAG,gCAAgCf,QAAhC,GAA2C,KAA1D;;AAEA,MAAI,iBAAiBgB,IAAjB,CAAsBJ,QAAtB,KAAmC,iBAAiBI,IAAjB,CAAsBH,IAAtB,CAAvC,EAAoE;AAClEE,IAAAA,QAAQ,IACJ,gCAAgCd,iBAAiB,EAAjD,GAAsD,KAAtD,GACA,yBADA,GAC4Ba,aAAa,EADzC,GAC8C,KAFlD;AAGD;;AAED9C,EAAAA,EAAE,CAACiD,aAAH,CAAiB7C,IAAI,CAACgB,IAAL,CAAUD,OAAV,EAAmB,aAAnB,CAAjB,EAAoD4B,QAApD;AACD;;AAED,SAAS9B,IAAT,CAAcmB,IAAd,EAAoB;AAClBvB,EAAAA,SAAS,GAAG,IAAZ;AACAJ,EAAAA,OAAO,CAACC,GAAR,CAAYC,IAAZ,GAAmBH,YAAnB;AACAC,EAAAA,OAAO,CAACQ,IAAR,CAAamB,IAAI,IAAI,CAArB;AACD;;AAGD,SAASc,yBAAT,GAAqC;AACnC,MAAIC,GAAG,GAAGC,IAAI,CAACD,GAAL,EAAV;AACA,MAAIE,gBAAgB,GAAG,CACrB5C,OAAO,CAACC,GAAR,CAAY4C,MAAZ,IAAsB7C,OAAO,CAACC,GAAR,CAAY6C,IAAlC,IAA0C9C,OAAO,CAACC,GAAR,CAAY8C,cADjC,EAErB,MAFqB,EAGrBpD,IAAI,CAACgB,IAAL,CAAUX,OAAO,CAACgD,GAAR,EAAV,EAAyB,KAAzB,CAHqB,CAAvB;;AAMA,OAAK,IAAIC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGL,gBAAgB,CAACM,MAArC,EAA6CD,CAAC,EAA9C,EAAkD;AAChD,QAAIE,aAAa,GAAGxD,IAAI,CAACgB,IAAL,CAAUiC,gBAAgB,CAACK,CAAD,CAA1B,EAA+B,WAA/B,CAApB;;AAEA,QAAI;AACF1D,MAAAA,EAAE,CAAC6D,UAAH,CAAcD,aAAd,EAA6B,MAA7B,EADE,CAEF;AACA;;AACA5D,MAAAA,EAAE,CAACkC,SAAH,CAAa0B,aAAb,EAA4B,MAA5B;AACA,UAAIE,QAAQ,GAAG1D,IAAI,CAACgB,IAAL,CAAUwC,aAAV,EAAyBT,GAAG,GAAG,MAA/B,CAAf;AACAnD,MAAAA,EAAE,CAACiD,aAAH,CAAiBa,QAAjB,EAA2B,MAA3B;AACA9D,MAAAA,EAAE,CAAC+D,UAAH,CAAcD,QAAd;AACA,aAAOF,aAAP;AACD,KATD,CASE,OAAOI,CAAP,EAAU;AACVjD,MAAAA,OAAO,CAACC,GAAR,CAAY4C,aAAZ,EAA2B,kBAA3B,EAA+CI,CAAC,CAACC,OAAjD;AACD;AACF;;AAEDlD,EAAAA,OAAO,CAACsB,KAAR,CAAc,gEACV,iEADU,GAEV,0BAFJ;AAGApB,EAAAA,IAAI,CAAC,CAAD,CAAJ;AACD;;AAGD,SAASiD,iBAAT,GAA6B;AAC3B,MAAIC,SAAS,GAAG,CAAC,CAAC1D,OAAO,CAACC,GAAR,CAAY0D,qBAA9B;;AACA,MAAI3D,OAAO,CAAC4D,OAAR,IAAmB,UAAvB,EAAmC;AACjCtD,IAAAA,OAAO,CAACC,GAAR,CAAY,kGAAZ;AACAmD,IAAAA,SAAS,GAAG,KAAZ;AACD;;AAED,MAAIG,OAAO,GAAG;AACZC,IAAAA,GAAG,EAAEC,cAAc,EADP;AAEZC,IAAAA,QAAQ,EAAE,IAFE;AAEI;AAChBC,IAAAA,cAAc,EAAE,IAHJ;AAGU;AACtBC,IAAAA,OAAO,EAAE,EAJG;AAKZR,IAAAA,SAAS,EAAEA;AALC,GAAd;AAQA,MAAIS,QAAQ,GAAGnE,OAAO,CAACC,GAAR,CAAYmE,sBAAZ,IACXpE,OAAO,CAACC,GAAR,CAAYoE,qBADD,IAEXrE,OAAO,CAACC,GAAR,CAAYqE,gBAFhB;;AAGA,MAAIH,QAAJ,EAAc;AAEZ;AACA,QAAII,KAAK,GAAG1E,GAAG,CAAC2E,KAAJ,CAAUL,QAAV,CAAZ;;AACA,QAAII,KAAK,CAACE,IAAV,EAAgB;AACd;AACAF,MAAAA,KAAK,CAACE,IAAN,GAAaF,KAAK,CAACE,IAAN,CAAWvC,OAAX,CAAmB,MAAnB,EAA2B,SAA3B,CAAb;AACD;;AACD5B,IAAAA,OAAO,CAACC,GAAR,CAAY,iBAAiBV,GAAG,CAAC6E,MAAJ,CAAWH,KAAX,CAA7B,EARY,CAUZ;;AACAV,IAAAA,OAAO,CAACU,KAAR,GAAgBJ,QAAhB;AACD,GA9B0B,CAgC3B;;;AACAN,EAAAA,OAAO,CAACK,OAAR,CAAgB,YAAhB,IAAgClE,OAAO,CAACC,GAAR,CAAY0E,qBAA5C,CAjC2B,CAmC3B;;AACA,MAAIC,EAAE,GAAG5E,OAAO,CAACC,GAAR,CAAY4E,aAArB;;AACA,MAAI,CAACD,EAAD,IAAO5E,OAAO,CAACC,GAAR,CAAY6E,iBAAvB,EAA0C;AACxC,QAAI;AACFF,MAAAA,EAAE,GAAGrF,EAAE,CAACwF,YAAH,CAAgB/E,OAAO,CAACC,GAAR,CAAY6E,iBAA5B,EAA+C;AAACd,QAAAA,QAAQ,EAAE;AAAX,OAA/C,EACFgB,KADE,CACI,oCADJ,CAAL,CADE,CAIF;AACA;AACA;;AACA,UAAIJ,EAAE,CAAC1B,MAAH,GAAY,CAAZ,IAAiB,CAAC,8BAA8BX,IAA9B,CAAmCqC,EAAE,CAAC,CAAD,CAArC,CAAtB,EAAiE;AAC/DA,QAAAA,EAAE,CAACK,KAAH;AACD;AAEF,KAXD,CAWE,OAAO1B,CAAP,EAAU;AACVjD,MAAAA,OAAO,CAACsB,KAAR,CAAc,uBAAd,EAAuC5B,OAAO,CAACC,GAAR,CAAY6E,iBAAnD,EAAsEvB,CAAtE;AACD;AACF;;AAED,MAAIqB,EAAJ,EAAQ;AACNtE,IAAAA,OAAO,CAACC,GAAR,CAAY,kBAAZ;AACAsD,IAAAA,OAAO,CAACqB,YAAR,GAAuB;AACrBN,MAAAA,EAAE,EAAEA;AADiB,KAAvB;AAGAf,IAAAA,OAAO,CAACe,EAAR,GAAaA,EAAb;AACD;;AAED,SAAOf,OAAP;AACD;;AAED,SAASsB,kBAAT,CAA4BvD,KAA5B,EAAmC;AACjC,MAAIA,KAAK,IAAIA,KAAK,CAACK,KAAf,IAAwBL,KAAK,CAACK,KAAN,CAAYmD,OAAZ,CAAoB,2BAApB,KAAoD,CAAC,CAAjF,EAAoF;AAChF9E,IAAAA,OAAO,CAACsB,KAAR,CAAc,sDACV,qJADJ;AAEApB,IAAAA,IAAI,CAAC,CAAD,CAAJ;AACH,GAJD,MAIO,IAAIoB,KAAJ,EAAW;AAChBtB,IAAAA,OAAO,CAACsB,KAAR,CAAc,4BAA4BA,KAAK,CAACK,KAAlC,GAA0C,MAA1C,GACV,oEADJ;AAEAzB,IAAAA,IAAI,CAAC,CAAD,CAAJ;AACD,GAJM,MAIA;AACLF,IAAAA,OAAO,CAACsB,KAAR,CAAc,4DACV,4CADJ;AAEApB,IAAAA,IAAI,CAAC,CAAD,CAAJ;AACD;AACF;;AAED,SAAS6E,aAAT,CAAuBC,cAAvB,EAAuCC,QAAvC,EAAiD;AAC/C,MAAIC,QAAQ,GAAG9F,GAAG,CAAC+F,KAAJ,EAAf;AAEA,MAAIC,SAAS,GAAGH,QAAQ,GAAG,YAAX,GAA0B5C,IAAI,CAACD,GAAL,EAA1C;AAEApC,EAAAA,OAAO,CAACC,GAAR,CAAY,cAAZ;AACA,MAAIoF,GAAG,GAAG,IAAV;AACAzG,EAAAA,eAAe,CAACU,OAAO,CAAC0F,cAAD,EAAiB,UAAU1D,KAAV,EAAiBgE,QAAjB,EAA2BC,IAA3B,EAAiC;AACvEvF,IAAAA,OAAO,CAACC,GAAR,CAAY,EAAZ;;AACA,QAAI,CAACqB,KAAD,IAAUgE,QAAQ,CAACE,UAAT,KAAwB,GAAtC,EAA2C;AACzCvG,MAAAA,EAAE,CAACiD,aAAH,CAAiBkD,SAAjB,EAA4BG,IAA5B;AACAvF,MAAAA,OAAO,CAACC,GAAR,CAAY,cAAcwF,IAAI,CAACC,KAAL,CAAWH,IAAI,CAAC3C,MAAL,GAAc,IAAzB,CAAd,GAA+C,UAA3D;AACA3D,MAAAA,EAAE,CAAC0G,UAAH,CAAcP,SAAd,EAAyBH,QAAzB;AACAC,MAAAA,QAAQ,CAACzE,OAAT,CAAiBwE,QAAjB;AAED,KAND,MAMO,IAAIK,QAAJ,EAAc;AACnBtF,MAAAA,OAAO,CAACsB,KAAR,CAAc,gCACV,UADU,GACGgE,QAAQ,CAACE,UADZ,GACyB,IADzB,GAEV,mBAFU,GAEYI,IAAI,CAACC,SAAL,CAAeb,cAAf,EAA+B,IAA/B,EAAqC,CAArC,CAFZ,GAEsD,IAFtD,GAGV,oBAHU,GAGaY,IAAI,CAACC,SAAL,CAAeP,QAAQ,CAAC1B,OAAxB,EAAiC,IAAjC,EAAuC,CAAvC,CAHb,GAGyD,IAHzD,GAIV,4DAJU,GAKV,iEALU,GAMV,qCANJ;AAOA1D,MAAAA,IAAI,CAAC,CAAD,CAAJ;AACD,KATM,MASA;AACL2E,MAAAA,kBAAkB,CAACvD,KAAD,CAAlB;AACD;AACF,GApBsB,CAAR,CAAf,CAoBIvB,EApBJ,CAoBO,UApBP,EAoBmB,UAAU+F,KAAV,EAAiB;AAClC,QAAI;AACF,UAAI,CAACT,GAAL,EAAU;AACRA,QAAAA,GAAG,GAAG,IAAIvG,QAAJ,CAAa,mBAAb,EAAkC;AAACiH,UAAAA,KAAK,EAAED,KAAK,CAACE,IAAN,CAAWD,KAAnB;AAA0BE,UAAAA,KAAK,EAAE;AAAjC,SAAlC,CAAN;AACD;;AACDZ,MAAAA,GAAG,CAACa,IAAJ,GAAWJ,KAAK,CAACE,IAAN,CAAWG,WAAtB;AACAd,MAAAA,GAAG,CAACe,IAAJ;AACD,KAND,CAME,OAAOnD,CAAP,EAAU,CACV;AACD;AACF,GA9BD,EA+BClD,EA/BD,CA+BI,OA/BJ,EA+Ba8E,kBA/Bb;AAiCA,SAAOK,QAAQ,CAACmB,OAAhB;AACD;;AAGD,SAASvF,eAAT,CAAyBmE,QAAzB,EAAmC;AACjC,MAAIC,QAAQ,GAAG9F,GAAG,CAAC+F,KAAJ,EAAf,CADiC,CAEjC;AACA;;AACA,MAAIpE,aAAa,GAAGkE,QAAQ,GAAG,WAAX,GAAyB5C,IAAI,CAACD,GAAL,EAA7C;AACA,MAAImB,OAAO,GAAG;AAACb,IAAAA,GAAG,EAAE3B;AAAN,GAAd;AAEA9B,EAAAA,EAAE,CAAC6D,UAAH,CAAc/B,aAAd,EAA6B,MAA7B,EAPiC,CAQjC;AACA;;AACA9B,EAAAA,EAAE,CAACkC,SAAH,CAAaJ,aAAb,EAA4B,MAA5B;;AAEA,MAAIkE,QAAQ,CAACqB,MAAT,CAAgB,CAAC,CAAjB,MAAwB,MAA5B,EAAoC;AAClCtG,IAAAA,OAAO,CAACC,GAAR,CAAY,yBAAZ;AACAlB,IAAAA,UAAU,CAACM,IAAI,CAACoB,OAAL,CAAawE,QAAb,CAAD,EAAyB;AAACsB,MAAAA,GAAG,EAAExF;AAAN,KAAzB,EAA+C,UAASK,GAAT,EAAc;AACrE,UAAIA,GAAJ,EAAS;AACPpB,QAAAA,OAAO,CAACsB,KAAR,CAAc,sBAAd;AACA4D,QAAAA,QAAQ,CAACsB,MAAT,CAAgBpF,GAAhB;AACD,OAHD,MAGO;AACL8D,QAAAA,QAAQ,CAACzE,OAAT,CAAiBM,aAAjB;AACD;AACF,KAPS,CAAV;AASD,GAXD,MAWO;AACLf,IAAAA,OAAO,CAACC,GAAR,CAAY,+CAAZ;AACAjB,IAAAA,EAAE,CAACyH,QAAH,CAAY,KAAZ,EAAmB,CAAC,KAAD,EAAQpH,IAAI,CAACoB,OAAL,CAAawE,QAAb,CAAR,CAAnB,EAAoD1B,OAApD,EAA6D,UAAUnC,GAAV,EAAe;AAC1E,UAAIA,GAAJ,EAAS;AACPpB,QAAAA,OAAO,CAACsB,KAAR,CAAc,0BAAd;AACA4D,QAAAA,QAAQ,CAACsB,MAAT,CAAgBpF,GAAhB;AACD,OAHD,MAGO;AACL8D,QAAAA,QAAQ,CAACzE,OAAT,CAAiBM,aAAjB;AACD;AACF,KAPD;AAQD;;AACD,SAAOmE,QAAQ,CAACmB,OAAhB;AACD;;AAGD,SAASrF,aAAT,CAAuBD,aAAvB,EAAsC2F,UAAtC,EAAkD;AAChD1G,EAAAA,OAAO,CAACC,GAAR,CAAY,UAAZ,EAAwByG,UAAxB;AACA,SAAOtH,GAAG,CAACuH,MAAJ,CAAW1H,EAAE,CAAC2H,MAAd,EAAsBF,UAAtB,EAAkChG,IAAlC,CAAuC,YAAY;AACxD;AACA,QAAImG,KAAK,GAAG5H,EAAE,CAAC6H,WAAH,CAAe/F,aAAf,CAAZ;;AACA,SAAK,IAAI4B,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGkE,KAAK,CAACjE,MAA1B,EAAkCD,CAAC,EAAnC,EAAuC;AACrC,UAAIoE,IAAI,GAAG1H,IAAI,CAACgB,IAAL,CAAUU,aAAV,EAAyB8F,KAAK,CAAClE,CAAD,CAA9B,CAAX;;AACA,UAAI1D,EAAE,CAAC+H,QAAH,CAAYD,IAAZ,EAAkBE,WAAlB,MAAmCF,IAAI,CAACjC,OAAL,CAAa3F,MAAM,CAACmE,OAApB,KAAgC,CAAC,CAAxE,EAA2E;AACzEtD,QAAAA,OAAO,CAACC,GAAR,CAAY,0BAAZ,EAAwC8G,IAAxC,EAA8C,IAA9C,EAAoDL,UAApD;AACA,eAAOtH,GAAG,CAACuH,MAAJ,CAAW1H,EAAE,CAACiI,IAAd,EAAoBH,IAApB,EAA0BL,UAA1B,CAAP;AACD;AACF;;AAED1G,IAAAA,OAAO,CAACC,GAAR,CAAY,+BAAZ,EAA6C4G,KAA7C;AACA,UAAM,IAAIM,KAAJ,CAAU,+BAAV,CAAN;AACD,GAbM,CAAP;AAcD;;AAED,SAASC,gCAAT,CAA0ChH,OAA1C,EAAmD;AACjD,MAAIiH,SAAS,GAAGxI,OAAO,CAACuB,OAAD,CAAvB;;AACA,MAAIiH,SAAS,CAACpG,QAAV,IACAC,iBAAiB,MAAMmG,SAAS,CAACxF,QADjC,IAEAE,aAAa,MAAMsF,SAAS,CAACvF,IAFjC,EAEuC;AACrC,QAAI;AACF,UAAIwF,gBAAgB,GAAGjI,IAAI,CAACoB,OAAL,CAAapB,IAAI,CAACkI,OAAL,CAAanH,OAAb,CAAb,EAAoCiH,SAAS,CAACpG,QAA9C,CAAvB;;AACA,UAAIhC,EAAE,CAAC+H,QAAH,CAAYM,gBAAZ,CAAJ,EAAmC;AACjC,eAAOA,gBAAP;AACD;AACF,KALD,CAKE,OAAOrE,CAAP,EAAU,CACV;AACD;AACF;;AACD,SAAO,KAAP;AACD;AAED;;;;;AAGA,SAAStC,iBAAT,GAA6B;AAC3B,SAAOvB,GAAG,CAACoI,KAAJ,CAAU,YAAY;AAC3B,QAAIvG,QAAQ,GAAGmG,gCAAgC,CAAC,mBAAD,CAA/C;;AACA,QAAInG,QAAJ,EAAc;AACZjB,MAAAA,OAAO,CAACC,GAAR,CAAY,sCAAZ,EAAoDgB,QAApD;AACAf,MAAAA,IAAI,CAAC,CAAD,CAAJ;AACD;AACF,GANM,EAMJwB,IANI,CAMC,YAAY,CAClB;AACD,GARM,CAAP;AASD;AAED;;;;;AAGA,SAASd,kBAAT,GAA8B;AAC5B,MAAIM,iBAAiB,MAAMxB,OAAO,CAACmC,QAA/B,IAA2CE,aAAa,MAAMrC,OAAO,CAACoC,IAA1E,EAAgF;AAC9E9B,IAAAA,OAAO,CAACC,GAAR,CAAY,kCAAkCiB,iBAAiB,EAAnD,GAAwD,GAAxD,GAA8Da,aAAa,EAA3E,GACA,wBADZ;AAEA,WAAO3C,GAAG,CAACqB,OAAJ,CAAY,KAAZ,CAAP;AACD;;AAED,SAAOrB,GAAG,CAACuH,MAAJ,CAAWnH,KAAX,EAAkB,WAAlB,EACNkB,IADM,CACD,UAAU+G,MAAV,EAAkB;AACtBjH,IAAAA,WAAW,GAAGiH,MAAd;AACAzH,IAAAA,OAAO,CAACC,GAAR,CAAY,gCAAZ,EAA8CO,WAA9C,EAFsB,CAItB;AACA;;AACA,QAAIA,WAAW,CAACsE,OAAZ,CAAoBzF,IAAI,CAACgB,IAAL,CAAU,KAAV,EAAiB,WAAjB,CAApB,MAAuD,CAAC,CAA5D,EAA+D;AAC7DL,MAAAA,OAAO,CAACC,GAAR,CAAY,wEAAZ;AACA;AACD;;AAED,QAAI+B,QAAQ,GAAG/C,EAAE,CAACwF,YAAH,CAAgBjE,WAAhB,EAA6B,MAA7B,CAAf;;AACA,QAAI,qBAAqByB,IAArB,CAA0BD,QAA1B,CAAJ,EAAyC;AACvChC,MAAAA,OAAO,CAACC,GAAR,CAAY,gCAAZ;AAEA,UAAIyH,cAAc,GAAGN,gCAAgC,CACjD/H,IAAI,CAACoB,OAAL,CAAaxB,EAAE,CAAC0I,YAAH,CAAgBnH,WAAhB,CAAb,EAA2C,oBAA3C,CADiD,CAArD;;AAEA,UAAIkH,cAAJ,EAAoB;AAClB1H,QAAAA,OAAO,CAACC,GAAR,CAAY,8BAAZ,EAA4CyH,cAA5C;AACAjG,QAAAA,iBAAiB,CAACiG,cAAD,CAAjB;AACAxH,QAAAA,IAAI,CAAC,CAAD,CAAJ;AACD;;AAEDF,MAAAA,OAAO,CAACC,GAAR,CAAY,4CAAZ;AACD,KAZD,MAYO;AACL,aAAO2H,qBAAqB,CAACpH,WAAD,CAArB,CAAmCE,IAAnC,CAAwC,UAAUmH,OAAV,EAAmB;AAChE,YAAIA,OAAJ,EAAa;AACXpG,UAAAA,iBAAiB,CAACjB,WAAD,CAAjB;AACAR,UAAAA,OAAO,CAACC,GAAR,CAAY,2CAAZ,EAAyDO,WAAzD;AACAN,UAAAA,IAAI,CAAC,CAAD,CAAJ;AACD;AACF,OANM,CAAP;AAOD;AACF,GAlCM,EAkCJ,YAAY;AACbF,IAAAA,OAAO,CAACC,GAAR,CAAY,6BAAZ;AACD,GApCM,EAqCNyB,IArCM,CAqCD,UAAUN,GAAV,EAAe;AACnBpB,IAAAA,OAAO,CAACsB,KAAR,CAAc,iCAAd,EAAiDF,GAAjD;AACA,WAAO,KAAP;AACD,GAxCM,CAAP;AAyCD;AAED;;;;;;AAIA,SAASqC,cAAT,GAA0B;AACxB,MAAIqE,IAAI,GAAGC,eAAe,EAA1B;AACA,SAAOD,IAAI,IAAIA,IAAI,CAACvI,GAApB;AACD;AAED;;;;;;AAIA,SAASwI,eAAT,GAA2B;AACzB,MAAIC,MAAM,GAAGtI,OAAO,CAACC,GAAR,CAAYsI,2BAAZ,IACTvI,OAAO,CAACC,GAAR,CAAYuI,gBADH,IAETrI,WAFJ;AAGA,MAAIsI,WAAW,GAAGH,MAAM,GAAG,aAAT,GAAyB7I,MAAM,CAACmE,OAAhC,GAA0C,GAA5D;AACA,MAAI8E,QAAQ,GAAG,EAAf;AAEA,MAAIvG,QAAQ,GAAGX,iBAAiB,EAAhC;AACA,MAAIY,IAAI,GAAGC,aAAa,EAAxB;;AACA,MAAIF,QAAQ,KAAK,OAAb,IAAwBC,IAAI,KAAK,KAArC,EAA4C;AAC1CqG,IAAAA,WAAW,IAAI,sBAAf;AACAC,IAAAA,QAAQ,GAAG,kEAAX;AACD,GAHD,MAGO,IAAIvG,QAAQ,KAAK,OAAb,IAAwBC,IAAI,IAAI,MAApC,EAA4C;AACjDqG,IAAAA,WAAW,IAAI,oBAAf;AACAC,IAAAA,QAAQ,GAAG,kEAAX;AACD,GAHM,MAGA,IAAIvG,QAAQ,KAAK,QAAb,IAAyBA,QAAQ,KAAK,SAAtC,IAAmDA,QAAQ,KAAK,SAApE,EAA+E;AACpFsG,IAAAA,WAAW,IAAI,YAAf;AACAC,IAAAA,QAAQ,GAAG,kEAAX;AACD,GAHM,MAGA,IAAIvG,QAAQ,KAAK,OAAjB,EAA0B;AAC/BsG,IAAAA,WAAW,IAAI,aAAf;AACAC,IAAAA,QAAQ,GAAG,kEAAX;AACD,GAHM,MAGA;AACL,WAAO,IAAP;AACD;;AACD,SAAO;AAAC7I,IAAAA,GAAG,EAAE4I,WAAN;AAAmBC,IAAAA,QAAQ,EAAEA;AAA7B,GAAP;AACD;AAED;;;;;;;AAKA,SAASvH,iBAAT,GAA6B;AAC3B,MAAIwH,YAAY,GAAGN,eAAe,EAAlC;;AACA,MAAI,CAACM,YAAL,EAAmB;AACjBrI,IAAAA,OAAO,CAACsB,KAAR,CACI,0CAA0CJ,iBAAiB,EAA3D,GAAgE,GAAhE,GAAsEa,aAAa,EAAnF,GAAwF,IAAxF,GACA,wEADA,GAEA,mCAHJ;AAIA7B,IAAAA,IAAI,CAAC,CAAD,CAAJ;AACD;;AAED,MAAIiI,WAAW,GAAGE,YAAY,CAAC9I,GAA/B;AACA,MAAI+I,cAAJ;AAEA,SAAOlJ,GAAG,CAACoI,KAAJ,CAAU,YAAY;AAC3B;AACA,QAAIe,OAAO,GAAGpG,yBAAyB,EAAvC;AACA,QAAIqG,QAAQ,GAAGL,WAAW,CAACzD,KAAZ,CAAkB,GAAlB,EAAuB+D,GAAvB,EAAf;AACAH,IAAAA,cAAc,GAAGjJ,IAAI,CAACgB,IAAL,CAAUkI,OAAV,EAAmBC,QAAnB,CAAjB;;AAEA,QAAIvJ,EAAE,CAACyJ,UAAH,CAAcJ,cAAd,CAAJ,EAAmC;AACjCtI,MAAAA,OAAO,CAACC,GAAR,CAAY,+BAAZ,EAA6CqI,cAA7C;AACA,aAAOK,cAAc,CAACL,cAAD,EAAiBD,YAAY,CAACD,QAA9B,CAArB;AACD;;AACD,WAAO,KAAP;AACD,GAXM,EAWJ1H,IAXI,CAWC,UAAUkI,QAAV,EAAoB;AAC1B,QAAIA,QAAJ,EAAc;AACZ,aAAON,cAAP;AACD,KAHyB,CAK1B;;;AACAtI,IAAAA,OAAO,CAACC,GAAR,CAAY,aAAZ,EAA2BkI,WAA3B;AACAnI,IAAAA,OAAO,CAACC,GAAR,CAAY,WAAZ,EAAyBqI,cAAzB;AACA,WAAOvD,aAAa,CAAC5B,iBAAiB,EAAlB,EAAsBmF,cAAtB,CAApB;AACD,GApBM,CAAP;AAqBD;AAED;;;;;;;;AAMA,SAASK,cAAT,CAAwBH,QAAxB,EAAkCJ,QAAlC,EAA4C;AAC1C,SAAOhJ,GAAG,CAACqB,OAAJ,CAAYvB,KAAK,CAAC2J,QAAN,CAAeL,QAAf,EAAyB;AAACM,IAAAA,SAAS,EAAE;AAAZ,GAAzB,CAAZ,EAA6DpI,IAA7D,CAAkE,UAAUqI,IAAV,EAAgB;AACvF,QAAItB,MAAM,GAAGW,QAAQ,IAAIW,IAAzB;;AACA,QAAItB,MAAJ,EAAY;AACVzH,MAAAA,OAAO,CAACC,GAAR,CAAY,iDAAZ;AACD,KAFD,MAEO;AACLD,MAAAA,OAAO,CAACC,GAAR,CAAY,wBAAZ;AACD;;AACD,WAAOwH,MAAP;AACD,GARM,EAQJ/F,IARI,CAQC,UAAUN,GAAV,EAAe;AACrBpB,IAAAA,OAAO,CAACsB,KAAR,CAAc,6BAAd,EAA6CF,GAA7C;AACA,WAAO,KAAP;AACD,GAXM,CAAP;AAYD;AAED;;;;;;AAIA,SAASwG,qBAAT,CAA+BpH,WAA/B,EAA4C;AAC1CR,EAAAA,OAAO,CAACC,GAAR,CAAY,oBAAZ,EAAkCO,WAAlC,EAA+C,cAA/C;AACA,SAAOpB,GAAG,CAACuH,MAAJ,CAAW3H,EAAE,CAACyH,QAAd,EAAwBjG,WAAxB,EAAqC,CAAC,WAAD,CAArC,EAAoDE,IAApD,CAAyD,UAAUsI,MAAV,EAAkB;AAChF,QAAI1F,OAAO,GAAG0F,MAAM,CAACC,IAAP,EAAd;;AACA,QAAI9J,MAAM,CAACmE,OAAP,IAAkBA,OAAtB,EAA+B;AAC7B,aAAO,IAAP;AACD,KAFD,MAEO;AACLtD,MAAAA,OAAO,CAACC,GAAR,CAAY,uCAAZ,EAAqD+I,MAAM,CAACC,IAAP,EAArD,EAAoE,GAApE,EAAyEzI,WAAW,GAAG,GAAvF;AACA,aAAO,KAAP;AACD;AACF,GARM,EAQJkB,IARI,CAQC,UAAUN,GAAV,EAAe;AACrBpB,IAAAA,OAAO,CAACsB,KAAR,CAAc,uCAAd,EAAuDF,GAAvD;AACA,WAAO,KAAP;AACD,GAXM,CAAP;AAYD;AAED;;;;;AAGA,SAASF,iBAAT,GAA6B;AAC3B,SAAOxB,OAAO,CAACC,GAAR,CAAYuJ,kBAAZ,IAAkCxJ,OAAO,CAACmC,QAAjD;AACD;AAED;;;;;AAGA,SAASE,aAAT,GAAyB;AACvB,SAAOrC,OAAO,CAACC,GAAR,CAAYwJ,cAAZ,IAA8BzJ,OAAO,CAACoC,IAA7C;AACD","sourcesContent":["// Copyright 2012 The Obvious Corporation.\n\n/*\n * This simply fetches the right version of phantom for the current platform.\n */\n\n'use strict'\n\nvar requestProgress = require('request-progress')\nvar progress = require('progress')\nvar extractZip = require('extract-zip')\nvar cp = require('child_process')\nvar fs = require('fs-extra')\nvar hasha = require('hasha')\nvar helper = require('./lib/phantomjs')\nvar kew = require('kew')\nvar path = require('path')\nvar request = require('request')\nvar url = require('url')\nvar which = require('which')\n\nvar originalPath = process.env.PATH\nvar DEFAULT_CDN = 'https://github.com/Medium/phantomjs/releases/download/v1.9.19'\n\n// If the process exits without going through exit(), then we did not complete.\nvar validExit = false\n\nprocess.on('exit', function () {\n  if (!validExit) {\n    console.log('Install exited unexpectedly')\n    exit(1)\n  }\n})\n\n// NPM adds bin directories to the path, which will cause `which` to find the\n// bin for this package not the actual phantomjs bin.  Also help out people who\n// put ./bin on their path\nprocess.env.PATH = helper.cleanPath(originalPath)\n\nvar libPath = path.join(__dirname, 'lib')\nvar pkgPath = path.join(libPath, 'phantom')\nvar phantomPath = null\n\n// If the user manually installed PhantomJS, we want\n// to use the existing version.\n//\n// Do not re-use a manually-installed PhantomJS with\n// a different version.\n//\n// Do not re-use an npm-installed PhantomJS, because\n// that can lead to weird circular dependencies between\n// local versions and global versions.\n// https://github.com/Obvious/phantomjs/issues/85\n// https://github.com/Medium/phantomjs/pull/184\nkew.resolve(true)\n  .then(tryPhantomjsInLib)\n  .then(tryPhantomjsOnPath)\n  .then(downloadPhantomjs)\n  .then(extractDownload)\n  .then(function (extractedPath) {\n    return copyIntoPlace(extractedPath, pkgPath)\n  })\n  .then(function () {\n    var location = getTargetPlatform() === 'win32' ?\n        path.join(pkgPath, 'phantomjs.exe') :\n        path.join(pkgPath, 'bin' ,'phantomjs')\n\n    try {\n      // Ensure executable is executable by all users\n      fs.chmodSync(location, '755')\n    } catch (err) {\n      if (err.code == 'ENOENT') {\n        console.error('chmod failed: phantomjs was not successfully copied to', location)\n        exit(1)\n      }\n      throw err\n    }\n\n    var relativeLocation = path.relative(libPath, location)\n    writeLocationFile(relativeLocation)\n\n    console.log('Done. Phantomjs binary available at', location)\n    exit(0)\n  })\n  .fail(function (err) {\n    console.error('Phantom installation failed', err, err.stack)\n    exit(1)\n  })\n\n\nfunction writeLocationFile(location) {\n  console.log('Writing location.js file')\n  if (getTargetPlatform() === 'win32') {\n    location = location.replace(/\\\\/g, '\\\\\\\\')\n  }\n\n  var platform = getTargetPlatform()\n  var arch = getTargetArch()\n\n  var contents = 'module.exports.location = \"' + location + '\"\\n'\n\n  if (/^[a-zA-Z0-9]*$/.test(platform) && /^[a-zA-Z0-9]*$/.test(arch)) {\n    contents +=\n        'module.exports.platform = \"' + getTargetPlatform() + '\"\\n' +\n        'module.exports.arch = \"' + getTargetArch() + '\"\\n'\n  }\n\n  fs.writeFileSync(path.join(libPath, 'location.js'), contents)\n}\n\nfunction exit(code) {\n  validExit = true\n  process.env.PATH = originalPath\n  process.exit(code || 0)\n}\n\n\nfunction findSuitableTempDirectory() {\n  var now = Date.now()\n  var candidateTmpDirs = [\n    process.env.TMPDIR || process.env.TEMP || process.env.npm_config_tmp,\n    '/tmp',\n    path.join(process.cwd(), 'tmp')\n  ]\n\n  for (var i = 0; i < candidateTmpDirs.length; i++) {\n    var candidatePath = path.join(candidateTmpDirs[i], 'phantomjs')\n\n    try {\n      fs.mkdirsSync(candidatePath, '0777')\n      // Make double sure we have 0777 permissions; some operating systems\n      // default umask does not allow write by default.\n      fs.chmodSync(candidatePath, '0777')\n      var testFile = path.join(candidatePath, now + '.tmp')\n      fs.writeFileSync(testFile, 'test')\n      fs.unlinkSync(testFile)\n      return candidatePath\n    } catch (e) {\n      console.log(candidatePath, 'is not writable:', e.message)\n    }\n  }\n\n  console.error('Can not find a writable tmp directory, please report issue ' +\n      'on https://github.com/Obvious/phantomjs/issues/59 with as much ' +\n      'information as possible.')\n  exit(1)\n}\n\n\nfunction getRequestOptions() {\n  var strictSSL = !!process.env.npm_config_strict_ssl\n  if (process.version == 'v0.10.34') {\n    console.log('Node v0.10.34 detected, turning off strict ssl due to https://github.com/joyent/node/issues/8894')\n    strictSSL = false\n  }\n\n  var options = {\n    uri: getDownloadUrl(),\n    encoding: null, // Get response as a buffer\n    followRedirect: true, // The default download path redirects to a CDN URL.\n    headers: {},\n    strictSSL: strictSSL\n  }\n\n  var proxyUrl = process.env.npm_config_https_proxy ||\n      process.env.npm_config_http_proxy ||\n      process.env.npm_config_proxy\n  if (proxyUrl) {\n\n    // Print using proxy\n    var proxy = url.parse(proxyUrl)\n    if (proxy.auth) {\n      // Mask password\n      proxy.auth = proxy.auth.replace(/:.*$/, ':******')\n    }\n    console.log('Using proxy ' + url.format(proxy))\n\n    // Enable proxy\n    options.proxy = proxyUrl\n  }\n\n  // Use the user-agent string from the npm config\n  options.headers['User-Agent'] = process.env.npm_config_user_agent\n\n  // Use certificate authority settings from npm\n  var ca = process.env.npm_config_ca\n  if (!ca && process.env.npm_config_cafile) {\n    try {\n      ca = fs.readFileSync(process.env.npm_config_cafile, {encoding: 'utf8'})\n        .split(/\\n(?=-----BEGIN CERTIFICATE-----)/g)\n\n      // Comments at the beginning of the file result in the first\n      // item not containing a certificate - in this case the\n      // download will fail\n      if (ca.length > 0 && !/-----BEGIN CERTIFICATE-----/.test(ca[0])) {\n        ca.shift()\n      }\n\n    } catch (e) {\n      console.error('Could not read cafile', process.env.npm_config_cafile, e)\n    }\n  }\n\n  if (ca) {\n    console.log('Using npmconf ca')\n    options.agentOptions = {\n      ca: ca\n    }\n    options.ca = ca\n  }\n\n  return options\n}\n\nfunction handleRequestError(error) {\n  if (error && error.stack && error.stack.indexOf('SELF_SIGNED_CERT_IN_CHAIN') != -1) {\n      console.error('Error making request, SELF_SIGNED_CERT_IN_CHAIN. ' +\n          'Please read https://github.com/Medium/phantomjs#i-am-behind-a-corporate-proxy-that-uses-self-signed-ssl-certificates-to-intercept-encrypted-traffic')\n      exit(1)\n  } else if (error) {\n    console.error('Error making request.\\n' + error.stack + '\\n\\n' +\n        'Please report this full log at https://github.com/Medium/phantomjs')\n    exit(1)\n  } else {\n    console.error('Something unexpected happened, please report this full ' +\n        'log at https://github.com/Medium/phantomjs')\n    exit(1)\n  }\n}\n\nfunction requestBinary(requestOptions, filePath) {\n  var deferred = kew.defer()\n\n  var writePath = filePath + '-download-' + Date.now()\n\n  console.log('Receiving...')\n  var bar = null\n  requestProgress(request(requestOptions, function (error, response, body) {\n    console.log('')\n    if (!error && response.statusCode === 200) {\n      fs.writeFileSync(writePath, body)\n      console.log('Received ' + Math.floor(body.length / 1024) + 'K total.')\n      fs.renameSync(writePath, filePath)\n      deferred.resolve(filePath)\n\n    } else if (response) {\n      console.error('Error requesting archive.\\n' +\n          'Status: ' + response.statusCode + '\\n' +\n          'Request options: ' + JSON.stringify(requestOptions, null, 2) + '\\n' +\n          'Response headers: ' + JSON.stringify(response.headers, null, 2) + '\\n' +\n          'Make sure your network and proxy settings are correct.\\n\\n' +\n          'If you continue to have issues, please report this full log at ' +\n          'https://github.com/Medium/phantomjs')\n      exit(1)\n    } else {\n      handleRequestError(error)\n    }\n  })).on('progress', function (state) {\n    try {\n      if (!bar) {\n        bar = new progress('  [:bar] :percent', {total: state.size.total, width: 40})\n      }\n      bar.curr = state.size.transferred\n      bar.tick()\n    } catch (e) {\n      // It doesn't really matter if the progress bar doesn't update.\n    }\n  })\n  .on('error', handleRequestError)\n\n  return deferred.promise\n}\n\n\nfunction extractDownload(filePath) {\n  var deferred = kew.defer()\n  // extract to a unique directory in case multiple processes are\n  // installing and extracting at once\n  var extractedPath = filePath + '-extract-' + Date.now()\n  var options = {cwd: extractedPath}\n\n  fs.mkdirsSync(extractedPath, '0777')\n  // Make double sure we have 0777 permissions; some operating systems\n  // default umask does not allow write by default.\n  fs.chmodSync(extractedPath, '0777')\n\n  if (filePath.substr(-4) === '.zip') {\n    console.log('Extracting zip contents')\n    extractZip(path.resolve(filePath), {dir: extractedPath}, function(err) {\n      if (err) {\n        console.error('Error extracting zip')\n        deferred.reject(err)\n      } else {\n        deferred.resolve(extractedPath)\n      }\n    })\n\n  } else {\n    console.log('Extracting tar contents (via spawned process)')\n    cp.execFile('tar', ['jxf', path.resolve(filePath)], options, function (err) {\n      if (err) {\n        console.error('Error extracting archive')\n        deferred.reject(err)\n      } else {\n        deferred.resolve(extractedPath)\n      }\n    })\n  }\n  return deferred.promise\n}\n\n\nfunction copyIntoPlace(extractedPath, targetPath) {\n  console.log('Removing', targetPath)\n  return kew.nfcall(fs.remove, targetPath).then(function () {\n    // Look for the extracted directory, so we can rename it.\n    var files = fs.readdirSync(extractedPath)\n    for (var i = 0; i < files.length; i++) {\n      var file = path.join(extractedPath, files[i])\n      if (fs.statSync(file).isDirectory() && file.indexOf(helper.version) != -1) {\n        console.log('Copying extracted folder', file, '->', targetPath)\n        return kew.nfcall(fs.move, file, targetPath)\n      }\n    }\n\n    console.log('Could not find extracted file', files)\n    throw new Error('Could not find extracted file')\n  })\n}\n\nfunction getLocationInLibModuleIfMatching(libPath) {\n  var libModule = require(libPath)\n  if (libModule.location &&\n      getTargetPlatform() == libModule.platform &&\n      getTargetArch() == libModule.arch) {\n    try {\n      var resolvedLocation = path.resolve(path.dirname(libPath), libModule.location)\n      if (fs.statSync(resolvedLocation)) {\n        return resolvedLocation\n      }\n    } catch (e) {\n      // fall through\n    }\n  }\n  return false\n}\n\n/**\n * Check to see if the binary in lib is OK to use. If successful, exit the process.\n */\nfunction tryPhantomjsInLib() {\n  return kew.fcall(function () {\n    var location = getLocationInLibModuleIfMatching('./lib/location.js')\n    if (location) {\n      console.log('PhantomJS is previously installed at', location)\n      exit(0)\n    }\n  }).fail(function () {\n    // silently swallow any errors\n  })\n}\n\n/**\n * Check to see if the binary on PATH is OK to use. If successful, exit the process.\n */\nfunction tryPhantomjsOnPath() {\n  if (getTargetPlatform() != process.platform || getTargetArch() != process.arch) {\n    console.log('Building for target platform ' + getTargetPlatform() + '/' + getTargetArch() +\n                '. Skipping PATH search')\n    return kew.resolve(false)\n  }\n\n  return kew.nfcall(which, 'phantomjs')\n  .then(function (result) {\n    phantomPath = result\n    console.log('Considering PhantomJS found at', phantomPath)\n\n    // Horrible hack to avoid problems during global install. We check to see if\n    // the file `which` found is our own bin script.\n    if (phantomPath.indexOf(path.join('npm', 'phantomjs')) !== -1) {\n      console.log('Looks like an `npm install -g` on windows; skipping installed version.')\n      return\n    }\n\n    var contents = fs.readFileSync(phantomPath, 'utf8')\n    if (/NPM_INSTALL_MARKER/.test(contents)) {\n      console.log('Looks like an `npm install -g`')\n\n      var globalLocation = getLocationInLibModuleIfMatching(\n          path.resolve(fs.realpathSync(phantomPath), '../../lib/location'))\n      if (globalLocation) {\n        console.log('Linking to global install at', globalLocation)\n        writeLocationFile(globalLocation)\n        exit(0)\n      }\n\n      console.log('Could not link global install, skipping...')\n    } else {\n      return checkPhantomjsVersion(phantomPath).then(function (matches) {\n        if (matches) {\n          writeLocationFile(phantomPath)\n          console.log('PhantomJS is already installed on PATH at', phantomPath)\n          exit(0)\n        }\n      })\n    }\n  }, function () {\n    console.log('PhantomJS not found on PATH')\n  })\n  .fail(function (err) {\n    console.error('Error checking path, continuing', err)\n    return false\n  })\n}\n\n/**\n * @return {?string} Get the download URL for phantomjs.\n *     May return null if no download url exists.\n */\nfunction getDownloadUrl() {\n  var spec = getDownloadSpec()\n  return spec && spec.url\n}\n\n/**\n * @return {?{url: string, checksum: string}} Get the download URL and expected\n *     SHA-256 checksum for phantomjs.  May return null if no download url exists.\n */\nfunction getDownloadSpec() {\n  var cdnUrl = process.env.npm_config_phantomjs_cdnurl ||\n      process.env.PHANTOMJS_CDNURL ||\n      DEFAULT_CDN\n  var downloadUrl = cdnUrl + '/phantomjs-' + helper.version + '-'\n  var checksum = ''\n\n  var platform = getTargetPlatform()\n  var arch = getTargetArch()\n  if (platform === 'linux' && arch === 'x64') {\n    downloadUrl += 'linux-x86_64.tar.bz2'\n    checksum = 'a1d9628118e270f26c4ddd1d7f3502a93b48ede334b8585d11c1c3ae7bc7163a'\n  } else if (platform === 'linux' && arch == 'ia32') {\n    downloadUrl += 'linux-i686.tar.bz2'\n    checksum = '4102450bb658157e9aef3e229828fade0aaa0de0663802b31a0edff4b5aedf85'\n  } else if (platform === 'darwin' || platform === 'openbsd' || platform === 'freebsd') {\n    downloadUrl += 'macosx.zip'\n    checksum = '8f15043ae3031815dc5f884ea6ffa053d365491b1bc0dc3a0862d5ff1ac20a48'\n  } else if (platform === 'win32') {\n    downloadUrl += 'windows.zip'\n    checksum = 'da36853ece7d58b6f50813d3e598d8a16bb191b467ac32e1624a239a49de9104'\n  } else {\n    return null\n  }\n  return {url: downloadUrl, checksum: checksum}\n}\n\n/**\n * Download phantomjs, reusing the existing copy on disk if available.\n * Exits immediately if there is no binary to download.\n * @return {Promise.<string>} The path to the downloaded file.\n */\nfunction downloadPhantomjs() {\n  var downloadSpec = getDownloadSpec()\n  if (!downloadSpec) {\n    console.error(\n        'Unexpected platform or architecture: ' + getTargetPlatform() + '/' + getTargetArch() + '\\n' +\n        'It seems there is no binary available for your platform/architecture\\n' +\n        'Try to install PhantomJS globally')\n    exit(1)\n  }\n\n  var downloadUrl = downloadSpec.url\n  var downloadedFile\n\n  return kew.fcall(function () {\n    // Can't use a global version so start a download.\n    var tmpPath = findSuitableTempDirectory()\n    var fileName = downloadUrl.split('/').pop()\n    downloadedFile = path.join(tmpPath, fileName)\n\n    if (fs.existsSync(downloadedFile)) {\n      console.log('Download already available at', downloadedFile)\n      return verifyChecksum(downloadedFile, downloadSpec.checksum)\n    }\n    return false\n  }).then(function (verified) {\n    if (verified) {\n      return downloadedFile\n    }\n\n    // Start the install.\n    console.log('Downloading', downloadUrl)\n    console.log('Saving to', downloadedFile)\n    return requestBinary(getRequestOptions(), downloadedFile)\n  })\n}\n\n/**\n * Check to make sure that the file matches the checksum.\n * @param {string} fileName\n * @param {string} checksum\n * @return {Promise.<boolean>}\n */\nfunction verifyChecksum(fileName, checksum) {\n  return kew.resolve(hasha.fromFile(fileName, {algorithm: 'sha256'})).then(function (hash) {\n    var result = checksum == hash\n    if (result) {\n      console.log('Verified checksum of previously downloaded file')\n    } else {\n      console.log('Checksum did not match')\n    }\n    return result\n  }).fail(function (err) {\n    console.error('Failed to verify checksum: ', err)\n    return false\n  })\n}\n\n/**\n * Check to make sure a given binary is the right version.\n * @return {kew.Promise.<boolean>}\n */\nfunction checkPhantomjsVersion(phantomPath) {\n  console.log('Found PhantomJS at', phantomPath, '...verifying')\n  return kew.nfcall(cp.execFile, phantomPath, ['--version']).then(function (stdout) {\n    var version = stdout.trim()\n    if (helper.version == version) {\n      return true\n    } else {\n      console.log('PhantomJS detected, but wrong version', stdout.trim(), '@', phantomPath + '.')\n      return false\n    }\n  }).fail(function (err) {\n    console.error('Error verifying phantomjs, continuing', err)\n    return false\n  })\n}\n\n/**\n * @return {string}\n */\nfunction getTargetPlatform() {\n  return process.env.PHANTOMJS_PLATFORM || process.platform\n}\n\n/**\n * @return {string}\n */\nfunction getTargetArch() {\n  return process.env.PHANTOMJS_ARCH || process.arch\n}\n"],"file":"install.js"}